#!/usr/bin/php

<?php

use GuzzleHttp\Psr7\Request;
use M6Web\Tornado\Adapter\Guzzle\CurlMultiClientWrapper;
use M6Web\Tornado\HttpClient;
use M6Web\Tornado\Adapter\Tornado\EventLoop;
use M6Web\Tornado\Promise;

include __DIR__ . "/../vendor/autoload.php";

const BASE_URI = 'http://localhost:3000/';

if (isset($argv[1])) {
    $eventLoop = new EventLoop();
    $httpClient = new \M6Web\Tornado\Adapter\Guzzle\HttpClient($eventLoop, new CurlMultiClientWrapper());
    switch ($argv[1]) {
        case 'bookCount':
            displayBookCount($eventLoop, $httpClient);
            break;
        default:
            die('Unknown argument. RTFM pleaseâ€¦');
    }
}

function displayBookCount(EventLoop $eventLoop, HttpClient $httpClient)
{
    /** @var Promise $bookCount */
    $bookCount = $eventLoop->async(getBookCount($httpClient));
    $bookCount = $eventLoop->wait($bookCount);
    echo "There are $bookCount books available.\n\n";
}

function getBookCount(HttpClient $httpClient): Generator
{
    $request = new Request('GET', BASE_URI . 'list');
    $response = yield $httpClient->sendRequest($request);
    $data = json_decode($response->getBody()->getContents(), true);
    return count($data);
}

?>